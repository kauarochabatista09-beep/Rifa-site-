<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Rifas Premium</title>
  <link rel="stylesheet" href="style.css" />
</head>

<body>

  <!-- NAV / TOPO -->
  <header class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div class="brand-badge">ADMIT ONE</div>

        <div class="brand-text">
          <div class="brand-line">
            <span class="brand-title gold3d">Rifas Premium</span>
            <span class="blue-bolt blink">‚ö°</span>
          </div>
          <div class="brand-sub">Compre seu n√∫mero e concorra!</div>
        </div>
      </div>

      <!-- BOT√ÉO MENU 3 TRA√áOS DOURADO -->
      <button class="menu-btn" onclick="openMenu()" aria-label="Abrir menu">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>

    <!-- LETREIRO INFINITO -->
    <div class="marquee-wrap">
      <div class="marquee">
        <div class="marquee-track">
          <span class="marquee-item">
            ‚ú® RIFAS PREMIUM <span class="blue-bolt blink">‚ö°</span> ‚Ä¢ PAGUE NO PIX ‚Ä¢ RESERVE SEU N√öMERO ‚Ä¢ BOA SORTE ‚ú®
          </span>
          <span class="marquee-item">
            ‚ú® RIFAS PREMIUM <span class="blue-bolt blink">‚ö°</span> ‚Ä¢ PAGUE NO PIX ‚Ä¢ RESERVE SEU N√öMERO ‚Ä¢ BOA SORTE ‚ú®
          </span>
          <span class="marquee-item">
            ‚ú® RIFAS PREMIUM <span class="blue-bolt blink">‚ö°</span> ‚Ä¢ PAGUE NO PIX ‚Ä¢ RESERVE SEU N√öMERO ‚Ä¢ BOA SORTE ‚ú®
          </span>
        </div>
      </div>
    </div>
  </header>

  <!-- MENU LATERAL -->
  <div class="side-menu" id="sideMenu">
    <div class="menu-overlay" onclick="closeMenu()"></div>

    <div class="menu-panel">
      <div class="menu-header">
        <div class="menu-title gold3d">Menu</div>
        <button class="menu-close" onclick="closeMenu()">√ó</button>
      </div>

      <a class="menu-item" href="#rifasAtivas" onclick="closeMenu()">üéüÔ∏è Rifas ativas</a>
      <button class="menu-item" onclick="goGanhadores()">üèÜ Ganhadores</button>
      <button class="menu-item" onclick="goComoFunciona()">‚ÑπÔ∏è Como funciona</button>
      <button class="menu-item" onclick="contactWhats()">üì≤ Falar no WhatsApp</button>

      <div class="menu-footer">
        <small>¬© <span id="yearMenu"></span> Rifas Premium</small>
      </div>
    </div>
  </div>

  <!-- CONTE√öDO -->
  <main class="container">
    <section class="section-title" id="rifasAtivas">
      <h2>üî• Rifas ativas</h2>
      <p>Escolha uma rifa e reserve seus n√∫meros</p>
    </section>

    <section id="rifasArea"></section>

    <section class="footer-note">
      <p>¬© <span id="year"></span> Rifas Premium</p>
    </section>
  </main>

  <!-- MODAL DE COMPRA -->
  <div class="modal" id="modal">
    <div class="modal-card">
      <button class="modal-close" onclick="closeModal()">√ó</button>

      <h3 class="gold3d">Finalizar reserva</h3>
      <p id="modalRifaName"></p>

      <div class="modal-grid">
        <div class="field">
          <label>Seu nome</label>
          <input id="buyerName" placeholder="Ex: Maria Silva" />
        </div>
        <div class="field">
          <label>WhatsApp</label>
          <input id="buyerPhone" placeholder="Ex: 11999999999" />
        </div>
      </div>

      <div class="field">
        <label>N√∫meros selecionados</label>
        <div class="chips" id="selectedChips"></div>
      </div>

      <!-- ‚úÖ PROMO√á√ïES (NOVO) -->
      <div class="field">
        <label>üî• Promo√ß√µes r√°pidas</label>
        <div class="promo-actions">
          <button class="btn" type="button" onclick="addRandomNumbers(1)">+1 n√∫mero</button>
          <button class="btn" type="button" onclick="addRandomNumbers(3)">3 n√∫meros (promo)</button>
          <button class="btn" type="button" onclick="addRandomNumbers(5)">5 n√∫meros (promo)</button>
        </div>
        <div class="promo-hint">
          ‚úÖ 3 n√∫meros por <b>R$10</b> ‚Ä¢ ‚úÖ 5 n√∫meros por <b>R$20</b>
        </div>
      </div>

      <div class="paybox">
        <div>
          <div class="pay-title">Pagamento via PIX</div>
          <div class="pay-sub">Copie a chave e envie o comprovante</div>
        </div>

        <div class="pix">
          <input id="pixKey" readonly />
          <button class="btn" onclick="copyPix()">Copiar PIX</button>
        </div>

        <div class="pay-total" id="totalValue">Total: R$ 0,00</div>

        <button class="btn-primary" onclick="sendWhats()">Enviar comprovante no WhatsApp</button>
      </div>
    </div>
  </div>

  <script>
    const STORAGE_KEY = "rifas_premium_data_v1";

    const defaultData = {
      pixKey: "b3764325-afe3-40c4-a0fb-a532b88c0717",
      whatsapp: "5511989448748",
      rifas: [],
      ganhadores: []
    };

    let data = JSON.parse(localStorage.getItem(STORAGE_KEY)) || defaultData;

    if (!localStorage.getItem(STORAGE_KEY)) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(defaultData));
      data = defaultData;
    }

    const money = (v) => v.toLocaleString("pt-BR", { style: "currency", currency: "BRL" });

    const year = new Date().getFullYear();
    document.getElementById("year").innerText = year;
    document.getElementById("yearMenu").innerText = year;

    function openMenu(){ document.getElementById("sideMenu").classList.add("open"); }
    function closeMenu(){ document.getElementById("sideMenu").classList.remove("open"); }

    function goGanhadores(){
      closeMenu();
      window.location.href = "ganhadores.html";
    }

    function goComoFunciona(){
      closeMenu();
      alert("Como funciona:\n\n1) Escolha seus n√∫meros\n2) Pague no PIX\n3) Envie comprovante no WhatsApp\n4) Sorteio ao vivo ‚úÖ");
    }

    function contactWhats(){
      closeMenu();
      const msg = encodeURIComponent("Ol√°! Quero participar das rifas Premium ‚ö°");
      window.open(`https://wa.me/${data.whatsapp}?text=${msg}`, "_blank");
    }

    function renderRifas() {
      const area = document.getElementById("rifasArea");
      area.innerHTML = "";

      if (!data.rifas.length) {
        area.innerHTML = `
          <div class="empty">
            <h3>Nenhuma rifa criada ainda</h3>
            <p>O admin precisa criar uma rifa no painel.</p>
          </div>
        `;
        return;
      }

      data.rifas.forEach((rifa, idx) => {
        const totalNumbers = rifa.totalNumbers || 100;
        const price = rifa.price || 10;
        const reserved = rifa.reserved || [];
        const reservedSet = new Set(reserved.map(r => r.n));

        // ===== BARRA DE PROGRESSO =====
        const vendidos = reserved.length;
        const total = totalNumbers;
        const pct = Math.min(100, Math.round((vendidos / total) * 100));
        const faltam = total - vendidos;
        const urgente = pct >= 80 ? `<span class="badge-hot">üî• QUASE ESGOTADO</span>` : "";

        const img = rifa.imageUrl ? `
          <div class="rifa-photo">
            <img src="${rifa.imageUrl}" alt="Foto do pr√™mio" />
          </div>
        ` : "";

        const card = document.createElement("div");
        card.className = "rifa-card";

        card.innerHTML = `
          ${img}

          <div class="rifa-head">
            <div>
              <h3 class="gold3d">${rifa.title}</h3>
              <div class="rifa-sub">${rifa.subtitle || "Pr√™mio incr√≠vel!"}</div>
            </div>
            <div class="rifa-price">${money(price)}/n√∫mero</div>
          </div>

          <div class="numbers" id="numbers_${idx}"></div>

          <!-- BARRA DE PROGRESSO -->
          <div class="progress-wrap">
            <div class="progress-top">
              <div class="left">Progresso da rifa ${urgente}</div>
              <div class="right">${pct}% vendido ‚Ä¢ faltam ${faltam}</div>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" style="width:${pct}%"></div>
              <div class="progress-glow"></div>
            </div>
          </div>

          <div class="rifa-bottom">
            <div class="rifa-stats">
              <span>${reserved.length} reservados</span>
              <span>‚Ä¢</span>
              <span>${totalNumbers - reserved.length} dispon√≠veis</span>
            </div>
            <button class="btn-primary" onclick="openModal(${idx})">Reservar n√∫meros</button>
          </div>
        `;

        area.appendChild(card);

        const numbersDiv = card.querySelector(`#numbers_${idx}`);
        for (let n = 1; n <= totalNumbers; n++) {
          const btn = document.createElement("button");
          btn.className = "num";
          btn.innerText = n.toString().padStart(2, "0");

          if (reservedSet.has(n)) {
            btn.classList.add("taken");
            btn.disabled = true;
          } else {
            btn.onclick = () => toggleNumber(idx, n, btn);
          }

          numbersDiv.appendChild(btn);
        }
      });
    }

    let currentRifaIndex = null;
    let selectedNumbers = [];

    function toggleNumber(idx, n, btn) {
      currentRifaIndex = idx;

      if (selectedNumbers.includes(n)) {
        selectedNumbers = selectedNumbers.filter(x => x !== n);
        btn.classList.remove("selected");
      } else {
        selectedNumbers.push(n);
        btn.classList.add("selected");
      }
    }

    function openModal(idx) {
      currentRifaIndex = idx;
      const rifa = data.rifas[idx];

      selectedNumbers = [];
      document.getElementById("buyerName").value = "";
      document.getElementById("buyerPhone").value = "";

      const nums = document.querySelectorAll(`#numbers_${idx} .num`);
      nums.forEach(el => el.classList.remove("selected"));

      document.getElementById("modalRifaName").innerText = `Rifa: ${rifa.title}`;
      document.getElementById("pixKey").value = data.pixKey;

      updateSelectedChips();
      updateTotal();

      document.getElementById("modal").classList.add("open");
    }

    function closeModal() { document.getElementById("modal").classList.remove("open"); }

    function updateSelectedChips() {
      const chips = document.getElementById("selectedChips");
      chips.innerHTML = "";
      selectedNumbers.sort((a,b)=>a-b).forEach(n => {
        const c = document.createElement("span");
        c.className = "chip";
        c.innerText = n.toString().padStart(2, "0");
        chips.appendChild(c);
      });
      if (!selectedNumbers.length) chips.innerHTML = `<span class="muted">Nenhum n√∫mero selecionado</span>`;
    }

    // ‚úÖ calcula total com promo√ß√µes
    function calcTotalWithPromo(pricePerNumber, qty) {
      // promo: 5 por 20
      const promo5 = Math.floor(qty / 5);
      qty = qty % 5;

      // promo: 3 por 10
      const promo3 = Math.floor(qty / 3);
      qty = qty % 3;

      const total =
        (promo5 * 20) +
        (promo3 * 10) +
        (qty * pricePerNumber);

      return total;
    }

    function updateTotal() {
      const rifa = data.rifas[currentRifaIndex] || { price: 0 };
      const price = (rifa.price || 0);
      const total = calcTotalWithPromo(price, selectedNumbers.length);
      document.getElementById("totalValue").innerText = `Total: ${money(total)}`;
    }

    // ‚úÖ pega n√∫meros dispon√≠veis aleat√≥rios e adiciona
    function addRandomNumbers(qty) {
      if (currentRifaIndex === null) return;

      const rifa = data.rifas[currentRifaIndex];
      const totalNumbers = rifa.totalNumbers || 100;
      const reserved = rifa.reserved || [];
      const reservedSet = new Set(reserved.map(r => r.n));
      const alreadySelected = new Set(selectedNumbers);

      const available = [];
      for (let n = 1; n <= totalNumbers; n++) {
        if (!reservedSet.has(n) && !alreadySelected.has(n)) available.push(n);
      }

      if (!available.length) {
        alert("N√£o h√° mais n√∫meros dispon√≠veis.");
        return;
      }

      // Embaralha
      for (let i = available.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [available[i], available[j]] = [available[j], available[i]];
      }

      const toAdd = available.slice(0, qty);

      toAdd.forEach(n => {
        selectedNumbers.push(n);
      });

      // marca visualmente
      const nums = document.querySelectorAll(`#numbers_${currentRifaIndex} .num`);
      nums.forEach(btn => {
        const num = parseInt(btn.innerText, 10);
        if (selectedNumbers.includes(num)) btn.classList.add("selected");
      });

      updateSelectedChips();
      updateTotal();
    }

    function copyPix() {
      const pix = document.getElementById("pixKey").value;
      navigator.clipboard.writeText(pix);
      alert("PIX copiado ‚úÖ");
    }

    function sendWhats() {
      if (currentRifaIndex === null) return;

      const name = document.getElementById("buyerName").value.trim();
      const phone = document.getElementById("buyerPhone").value.trim();

      if (!name || !phone) {
        alert("Preencha nome e WhatsApp.");
        return;
      }

      if (!selectedNumbers.length) {
        alert("Selecione ao menos 1 n√∫mero.");
        return;
      }

      const rifa = data.rifas[currentRifaIndex];
      rifa.reserved = rifa.reserved || [];

      selectedNumbers.forEach(n => {
        rifa.reserved.push({ n, name, phone, date: new Date().toISOString() });
      });

      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));

      const total = calcTotalWithPromo((rifa.price || 0), selectedNumbers.length);

      const msg = encodeURIComponent(
        `Ol√°! Quero participar da Rifa: ${rifa.title}\n` +
        `Nome: ${name}\n` +
        `WhatsApp: ${phone}\n` +
        `N√∫meros: ${selectedNumbers.sort((a,b)=>a-b).map(x => x.toString().padStart(2,'0')).join(", ")}\n` +
        `Total: ${money(total)}\n\n` +
        `Segue o comprovante do PIX ‚úÖ`
      );

      window.open(`https://wa.me/${data.whatsapp}?text=${msg}`, "_blank");

      closeModal();
      renderRifas();
    }

    document.addEventListener("click", () => {
      if (document.getElementById("modal").classList.contains("open")) {
        updateSelectedChips();
        updateTotal();
      }
    });

    renderRifas();
  </script>
</body>
</html>

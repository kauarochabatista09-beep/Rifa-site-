<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Rifas Premium</title>
  <link rel="stylesheet" href="style.css" />
</head>

<body>

  <!-- NAV / TOPO -->
  <header class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div class="brand-badge">ADMIT ONE</div>
        <div class="brand-text">
          <div class="brand-line">
            <span class="brand-title gold3d">Rifas Premium</span>
            <span class="blue-bolt blink">‚ö°</span>
          </div>
          <div class="brand-sub">Compre seu n√∫mero e concorra!</div>
        </div>
      </div>

      <a class="btn-admin" href="admin.html">Painel ADM</a>
    </div>

    <!-- LETREIRO INFINITO -->
    <div class="marquee-wrap">
      <div class="marquee">
        <div class="marquee-track">
          <span class="marquee-item">
            ‚ú® RIFAS PREMIUM <span class="blue-bolt blink">‚ö°</span> ‚Ä¢ PAGUE NO PIX ‚Ä¢ RESERVE SEU N√öMERO ‚Ä¢ BOA SORTE ‚ú®
          </span>
          <span class="marquee-item">
            ‚ú® RIFAS PREMIUM <span class="blue-bolt blink">‚ö°</span> ‚Ä¢ PAGUE NO PIX ‚Ä¢ RESERVE SEU N√öMERO ‚Ä¢ BOA SORTE ‚ú®
          </span>
          <span class="marquee-item">
            ‚ú® RIFAS PREMIUM <span class="blue-bolt blink">‚ö°</span> ‚Ä¢ PAGUE NO PIX ‚Ä¢ RESERVE SEU N√öMERO ‚Ä¢ BOA SORTE ‚ú®
          </span>
        </div>
      </div>
    </div>
  </header>

  <!-- CONTE√öDO -->
  <main class="container">
    <section class="section-title">
      <h2>üî• Rifas ativas</h2>
      <p>Escolha uma rifa e reserve seus n√∫meros</p>
    </section>

    <section id="rifasArea"></section>

    <section class="footer-note">
      <p>¬© <span id="year"></span> Rifas Premium</p>
    </section>
  </main>

  <!-- MODAL DE COMPRA -->
  <div class="modal" id="modal">
    <div class="modal-card">
      <button class="modal-close" onclick="closeModal()">√ó</button>

      <h3 class="gold3d">Finalizar reserva</h3>
      <p id="modalRifaName"></p>

      <div class="modal-grid">
        <div class="field">
          <label>Seu nome</label>
          <input id="buyerName" placeholder="Ex: Maria Silva" />
        </div>
        <div class="field">
          <label>WhatsApp</label>
          <input id="buyerPhone" placeholder="Ex: 11999999999" />
        </div>
      </div>

      <div class="field">
        <label>N√∫meros selecionados</label>
        <div class="chips" id="selectedChips"></div>
      </div>

      <div class="paybox">
        <div>
          <div class="pay-title">Pagamento via PIX</div>
          <div class="pay-sub">Copie a chave e envie o comprovante</div>
        </div>

        <div class="pix">
          <input id="pixKey" readonly />
          <button class="btn" onclick="copyPix()">Copiar PIX</button>
        </div>

        <div class="pay-total" id="totalValue">Total: R$ 0,00</div>

        <button class="btn-primary" onclick="sendWhats()">Enviar comprovante no WhatsApp</button>
      </div>
    </div>
  </div>

  <script>
    // ===== CONFIG PADR√ÉO =====
    const STORAGE_KEY = "rifas_premium_data_v1";

    const defaultData = {
      pixKey: "b3764325-afe3-40c4-a0fb-a532b88c0717",
      whatsapp: "5511989448748", // troque se quiser
      rifas: []
    };

    // ===== Estado =====
    let data = JSON.parse(localStorage.getItem(STORAGE_KEY)) || defaultData;

    // Se n√£o existe, salva default
    if (!localStorage.getItem(STORAGE_KEY)) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(defaultData));
      data = defaultData;
    }

    // ===== Util =====
    const money = (v) => v.toLocaleString("pt-BR", { style: "currency", currency: "BRL" });

    document.getElementById("year").innerText = new Date().getFullYear();

    // ===== Render =====
    function renderRifas() {
      const area = document.getElementById("rifasArea");
      area.innerHTML = "";

      if (!data.rifas.length) {
        area.innerHTML = `
          <div class="empty">
            <h3>Nenhuma rifa criada ainda</h3>
            <p>O admin precisa criar uma rifa no painel.</p>
          </div>
        `;
        return;
      }

      data.rifas.forEach((rifa, idx) => {
        const totalNumbers = rifa.totalNumbers || 100;
        const price = rifa.price || 10;
        const reserved = rifa.reserved || []; // [{n, name, phone}]

        const reservedSet = new Set(reserved.map(r => r.n));

        const card = document.createElement("div");
        card.className = "rifa-card";

        card.innerHTML = `
          <div class="rifa-head">
            <div>
              <h3 class="gold3d">${rifa.title}</h3>
              <div class="rifa-sub">${rifa.subtitle || "Pr√™mio incr√≠vel!"}</div>
            </div>
            <div class="rifa-price">${money(price)}/n√∫mero</div>
          </div>

          <div class="numbers" id="numbers_${idx}"></div>

          <div class="rifa-bottom">
            <div class="rifa-stats">
              <span>${reserved.length} reservados</span>
              <span>‚Ä¢</span>
              <span>${totalNumbers - reserved.length} dispon√≠veis</span>
            </div>
            <button class="btn-primary" onclick="openModal(${idx})">Reservar n√∫meros</button>
          </div>
        `;

        area.appendChild(card);

        // n√∫meros
        const numbersDiv = card.querySelector(`#numbers_${idx}`);
        for (let n = 1; n <= totalNumbers; n++) {
          const btn = document.createElement("button");
          btn.className = "num";
          btn.innerText = n.toString().padStart(2, "0");

          if (reservedSet.has(n)) {
            btn.classList.add("taken");
            btn.disabled = true;
          } else {
            btn.onclick = () => toggleNumber(idx, n, btn);
          }

          numbersDiv.appendChild(btn);
        }
      });
    }

    // ===== Sele√ß√£o =====
    let currentRifaIndex = null;
    let selectedNumbers = [];

    function toggleNumber(idx, n, btn) {
      currentRifaIndex = idx;

      if (selectedNumbers.includes(n)) {
        selectedNumbers = selectedNumbers.filter(x => x !== n);
        btn.classList.remove("selected");
      } else {
        selectedNumbers.push(n);
        btn.classList.add("selected");
      }
    }

    // ===== Modal =====
    function openModal(idx) {
      currentRifaIndex = idx;
      const rifa = data.rifas[idx];

      selectedNumbers = []; // reset
      document.getElementById("buyerName").value = "";
      document.getElementById("buyerPhone").value = "";

      // limpar selections nos bot√µes da rifa
      const nums = document.querySelectorAll(`#numbers_${idx} .num`);
      nums.forEach(el => el.classList.remove("selected"));

      document.getElementById("modalRifaName").innerText = `Rifa: ${rifa.title}`;
      document.getElementById("pixKey").value = data.pixKey;

      updateSelectedChips();
      updateTotal();

      document.getElementById("modal").classList.add("open");
    }

    function closeModal() {
      document.getElementById("modal").classList.remove("open");
    }

    function updateSelectedChips() {
      const chips = document.getElementById("selectedChips");
      chips.innerHTML = "";
      selectedNumbers.sort((a,b)=>a-b).forEach(n => {
        const c = document.createElement("span");
        c.className = "chip";
        c.innerText = n.toString().padStart(2, "0");
        chips.appendChild(c);
      });
      if (!selectedNumbers.length) {
        chips.innerHTML = `<span class="muted">Nenhum n√∫mero selecionado</span>`;
      }
    }

    function updateTotal() {
      const rifa = data.rifas[currentRifaIndex] || { price: 0 };
      const total = (rifa.price || 0) * selectedNumbers.length;
      document.getElementById("totalValue").innerText = `Total: ${money(total)}`;
    }

    function copyPix() {
      const pix = document.getElementById("pixKey").value;
      navigator.clipboard.writeText(pix);
      alert("PIX copiado ‚úÖ");
    }

    // ===== Whats + Reservar =====
    function sendWhats() {
      if (currentRifaIndex === null) return;

      const name = document.getElementById("buyerName").value.trim();
      const phone = document.getElementById("buyerPhone").value.trim();

      if (!name || !phone) {
        alert("Preencha nome e WhatsApp.");
        return;
      }

      if (!selectedNumbers.length) {
        alert("Selecione ao menos 1 n√∫mero.");
        return;
      }

      const rifa = data.rifas[currentRifaIndex];
      rifa.reserved = rifa.reserved || [];

      // Reservar n√∫meros no localStorage
      selectedNumbers.forEach(n => {
        rifa.reserved.push({ n, name, phone, date: new Date().toISOString() });
      });

      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));

      const total = (rifa.price || 0) * selectedNumbers.length;

      const msg = encodeURIComponent(
        `Ol√°! Quero participar da Rifa: ${rifa.title}\n` +
        `Nome: ${name}\n` +
        `WhatsApp: ${phone}\n` +
        `N√∫meros: ${selectedNumbers.sort((a,b)=>a-b).map(x => x.toString().padStart(2,'0')).join(", ")}\n` +
        `Total: ${money(total)}\n\n` +
        `Segue o comprovante do PIX ‚úÖ`
      );

      window.open(`https://wa.me/${data.whatsapp}?text=${msg}`, "_blank");

      closeModal();
      renderRifas();
    }

    // Atualiza chips/total quando clicar em reservar
    document.addEventListener("click", () => {
      if (document.getElementById("modal").classList.contains("open")) {
        updateSelectedChips();
        updateTotal();
      }
    });

    renderRifas();
  </script>
</body>
</html>
